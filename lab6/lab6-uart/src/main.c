/***********************************************************************
 *
 * Use USART unit and transmit data between ATmega328P and computer.
 *
 * ATmega328P (Arduino Uno), 16 MHz, PlatformIO
 *
 * Copyright (c) 2018 Tomas Fryza
 * Dept. of Radio Electronics, Brno University of Technology, Czechia
 * This work is licensed under the terms of the MIT license.
 *
 **********************************************************************/

/* Defines -----------------------------------------------------------*/
#ifndef F_CPU
#define F_CPU 16000000 // CPU frequency in Hz required for UART_BAUD_SELECT
#endif

/* Includes ----------------------------------------------------------*/
#include <avr/io.h>        // AVR device-specific IO definitions
#include <avr/interrupt.h> // Interrupts standard C library for AVR-GCC
#include "timer.h"         // Timer library for AVR-GCC
#include <uart.h>          // Peter Fleury's UART library
#include <stdlib.h>        // C library. Needed for number conversions
#include <stdio.h>
#include <string.h>

/* Function definitions ----------------------------------------------*/
/**********************************************************************
 * Function: Main function where the program execution begins
 * Purpose:  Use Timer/Counter1 and transmit UART data four times
 *           per second.
 * Returns:  none
 **********************************************************************/
int main(void)
{
  // Initialize USART to asynchronous, 8N1, 9600
  uart_init(UART_BAUD_SELECT(9600, F_CPU));

  // Configure 16-bit Timer/Counter1 to transmit UART data
  // Set prescaler to 262 ms and enable overflow interrupt
  TIM1_OVF_262MS
  TIM1_OVF_ENABLE

  // Enables interrupts by setting the global interrupt mask
  sei();

  // Put strings to ringbuffer for transmitting via UART
  uart_puts("Print one line... ");
  uart_puts("done\r\n");
  static unsigned char asciipic_txt[] = {                                                
  0x7c, 0x7c, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x7c, 0x7c,       
  0x0a, 0x7c, 0x7c, 0x2f, 0x2f, 0x24, 0x5c, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c,       
  0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c,       
  0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c,       
  0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c,       
  0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c,       
  0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x2f, 0x24, 0x5c, 0x5c, 0x7c,       
  0x7c, 0x0a, 0x7c, 0x7c, 0x28, 0x31, 0x30, 0x30, 0x29, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x7c, 0x20, 0x52, 0x45, 0x53, 0x45, 0x52, 0x56, 0x45,       
  0x20, 0x42, 0x41, 0x4e, 0x4b, 0x20, 0x4f, 0x46, 0x20, 0x49, 0x4e, 0x44,       
  0x49, 0x41, 0x7c, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,       
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x28, 0x31, 0x30, 0x30, 0x29,
  0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x5c, 0x5c, 0x24, 0x2f, 0x2f, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7e, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x27, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d,
  0x2d, 0x2d, 0x2d, 0x27, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5c, 0x5c, 0x24, 0x2f,
  0x2f, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x3c, 0x3c, 0x20, 0x2f, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x24, 0x5c, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f,
  0x2f, 0x20, 0x5f, 0x5f, 0x5f, 0x5f, 0x20, 0x5c, 0x5c, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5c, 0x20,
  0x3e, 0x3e, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x3e, 0x3e, 0x7c, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x2f, 0x4c, 0x5c, 0x5c, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f,
  0x2f, 0x20, 0x2f, 0x2f, 0x2f, 0x2e, 0x2e, 0x29, 0x20, 0x5c, 0x5c, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x58, 0x58, 0x58, 0x58, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x7c, 0x3c, 0x3c, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x3c, 0x3c, 0x7c, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5c, 0x5c, 0x20, 0x2f, 0x2f,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c,
  0x7c, 0x20, 0x3c, 0x7c, 0x7c, 0x20, 0x20, 0x3e, 0x5c, 0x20, 0x20, 0x7c,
  0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x7c, 0x3e, 0x3e, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x3e, 0x3e, 0x7c,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5c, 0x24, 0x2f,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x7c, 0x7c, 0x20, 0x20, 0x24, 0x24, 0x20, 0x2d, 0x2d, 0x2f, 0x20, 0x20,
  0x7c, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x58, 0x58, 0x58, 0x58, 0x58, 0x58, 0x58, 0x58, 0x58, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x7c, 0x3c, 0x3c, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x3c, 0x3c,
  0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x46, 0x72, 0x65, 0x65, 0x20, 0x74,
  0x6f, 0x20, 0x55, 0x73, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x2a, 0x5c, 0x5c, 0x20, 0x20, 0x7c, 0x5c, 0x5f, 0x2f, 0x20, 0x20,
  0x2f, 0x2f, 0x2a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x7c, 0x3e, 0x3e, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c, 0x3e,
  0x3e, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x2a, 0x5c, 0x5c, 0x2f, 0x5f, 0x5f, 0x5f, 0x5c, 0x5f,
  0x2f, 0x2f, 0x2a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x7c, 0x3c, 0x3c, 0x7c, 0x7c, 0x0a, 0x7c, 0x7c,
  0x3c, 0x3c, 0x5c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x52, 0x61, 0x74,
  0x69, 0x6e, 0x67, 0x3a, 0x20, 0x45, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f,
  0x5f, 0x5f, 0x5f, 0x5f, 0x2f, 0x20, 0x4d, 0x20, 0x47, 0x41, 0x4e, 0x44,
  0x48, 0x49, 0x20, 0x5c, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f,
  0x20, 0x20, 0x20, 0x20, 0x58, 0x58, 0x20, 0x58, 0x58, 0x58, 0x58, 0x58,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x3e, 0x3e, 0x7c, 0x7c, 0x0a, 0x7c,
  0x7c, 0x2f, 0x2f, 0x24, 0x5c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7e, 0x7c,
  0x20, 0x20, 0x20, 0x20, 0x52, 0x45, 0x50, 0x55, 0x42, 0x4c, 0x49, 0x43,
  0x20, 0x4f, 0x46, 0x20, 0x49, 0x4e, 0x44, 0x49, 0x41, 0x20, 0x20, 0x20,
  0x7c, 0x7e, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x24, 0x5c, 0x5c, 0x7c, 0x7c, 0x0a,
  0x7c, 0x7c, 0x28, 0x31, 0x30, 0x30, 0x29, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x20, 0x20, 0x20, 0x4f, 0x4e, 0x45, 0x20, 0x48, 0x55, 0x4e,
  0x44, 0x52, 0x45, 0x44, 0x20, 0x52, 0x55, 0x50, 0x45, 0x45, 0x53, 0x20,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x28, 0x31, 0x30, 0x30, 0x29, 0x7c, 0x7c,
  0x0a, 0x7c, 0x7c, 0x5c, 0x5c, 0x24, 0x2f, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f,
  0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f,
  0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f,
  0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f,
  0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f,
  0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x2f, 0x5c, 0x5c, 0x24, 0x2f, 0x2f, 0x7c,
  0x7c, 0x0a, 0x7c, 0x7c, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
  0x7c, 0x7c, 0x0a, 0x00
};
  uart_puts(asciipic_txt);

  // Infinite loop
  while (1)
  {
    /* Empty loop. All subsequent operations are performed exclusively
     * inside interrupt service routines ISRs */
  }

  // Will never reach this
  return 0;
}

/* Interrupt service routines ----------------------------------------*/
/**********************************************************************
 * Function: Timer/Counter1 overflow interrupt
 * Purpose:  Transmit UART data four times per second.
 **********************************************************************/
ISR(TIMER1_OVF_vect)
{
  // Transmit UART string(s)
  uint8_t value;
  char string[10];

  //uart_puts("      _/_/\n   _/    _/\n  _/_/_/_/\n _/    _/\n_/    _/\n");
  value = uart_getc();
  if (value != '\0')
  { // Data available from UART
    // Display ASCII code of received character
    itoa(value, string, 10);
    uart_putc(value);
    uart_puts("\x1b[4;32m");
    uart_puts("  Decimal:");
    uart_puts(string);

    itoa(value, string, 16);
    uart_puts("  HexaDecimal:0x");
    uart_puts(string);

    itoa(value, string, 2);
    uart_puts("  Binary:0b");
    uart_puts(string);
    uart_puts("\r\n");
  }
}